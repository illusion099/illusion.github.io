/*
* AbstractLoader for PreloadJS
* Visit http://createjs.com/ for documentation, updates and examples.
*
*
* Copyright (c) 2012 gskinner.com, inc.
*
* Permission is hereby granted, free of charge, to any person
* obtaining a copy of this software and associated documentation
* files (the "Software"), to deal in the Software without
* restriction, including without limitation the rights to use,
* copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the
* Software is furnished to do so, subject to the following
* conditions:
*
* The above copyright notice and this permission notice shall be
* included in all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
* OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
* HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
* WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
* FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*//**
 * @module PreloadJS
 */(function(e){var t=function(){this.init()};t.prototype={};var n=t.prototype;n.loaded=!1;n.progress=0;n._item=null;n.onProgress=null;n.onLoadStart=null;n.onFileLoad=null;n.onFileProgress=null;n.onComplete=null;n.onError=null;n.getItem=function(){return this._item};n.init=function(){};n.load=function(){};n.cancel=function(){};n._sendLoadStart=function(e){this.onLoadStart&&this.onLoadStart({target:this})};n._sendProgress=function(e){var t;if(e instanceof Number){this.progress=e;t={loaded:this.progress,total:1}}else{t=e;this.progress=e.loaded/e.total;if(isNaN(this.progress)||this.progress==Infinity)this.progress=0}t.target=this;this.onProgress&&this.onProgress(t)};n._sendFileProgress=function(e){if(this.onFileProgress){e.target=this;this.onFileProgress(e)}};n._sendComplete=function(){this.onComplete&&this.onComplete({target:this})};n._sendFileComplete=function(e){if(this.onFileLoad){e.target=this;this.onFileLoad(e)}};n._sendError=function(e){if(this.onError){e==null&&(e={});e.target=this;this.onError(e)}};n.toString=function(){return"[PreloadJS AbstractLoader]"};e.AbstractLoader=t})(window);(function(e){var t=function(e){this.initialize(e)},n=t.prototype=new AbstractLoader,r=t;r.IMAGE="image";r.SVG="svg";r.SOUND="sound";r.JSON="json";r.JAVASCRIPT="javascript";r.CSS="css";r.XML="xml";r.TEXT="text";r.TIMEOUT_TIME=8e3;n.useXHR=!0;n.stopOnError=!1;n.maintainScriptOrder=!0;n.next=null;n.typeHandlers=null;n.extensionHandlers=null;n._loadStartWasDispatched=!1;n._maxConnections=1;n._currentLoads=null;n._loadQueue=null;n._loadedItemsById=null;n._loadedItemsBySrc=null;n._targetProgress=0;n._numItems=0;n._numItemsLoaded=null;n._scriptOrder=null;n._loadedScripts=null;n.TAG_LOAD_OGGS=!0;n.initialize=function(t){this._numItems=0;this._numItemsLoaded=0;this._targetProgress=0;this._paused=!1;this._currentLoads=[];this._loadQueue=[];this._scriptOrder=[];this._loadedScripts=[];this._loadedItemsById={};this._loadedItemsBySrc={};this.typeHandlers={};this.extensionHandlers={};this._loadStartWasDispatched=!1;this.useXHR=t!=0&&e.XMLHttpRequest!=null;this.determineCapabilities()};n.determineCapabilities=function(){var e=t.lib.BrowserDetect;if(e==null)return;t.TAG_LOAD_OGGS=e.isFirefox||e.isOpera};r.isBinary=function(e){switch(e){case t.IMAGE:case t.SOUND:return!0;default:return!1}};n.installPlugin=function(e){if(e==null||e.getPreloadHandlers==null)return;var t=e.getPreloadHandlers();if(t.types!=null)for(var n=0,r=t.types.length;n<r;n++)this.typeHandlers[t.types[n]]=t.callback;if(t.extensions!=null)for(n=0,r=t.extensions.length;n<r;n++)this.extensionHandlers[t.extensions[n]]=t.callback};n.setMaxConnections=function(e){this._maxConnections=e;this._paused||this._loadNext()};n.loadFile=function(e,t){if(e==null){this._sendError({text:"File is null."});return}this._addItem(e);t!==!1&&this.setPaused(!1)};n.loadManifest=function(e,t){var n;if(e instanceof Array){if(e.length==0){this._sendError({text:"Manifest is empty."});return}n=e}else{if(e==null){this._sendError({text:"Manifest is null."});return}n=[e]}for(var r=0,i=n.length;r<i;r++)this._addItem(n[r],!1);t!==!1&&this._loadNext()};n.load=function(){this.setPaused(!1)};n.getResult=function(e){return this._loadedItemsById[e]||this._loadedItemsBySrc[e]};n.setPaused=function(e){this._paused=e;this._paused||this._loadNext()};n.close=function(){while(this._currentLoads.length)this._currentLoads.pop().cancel();this._currentLoads=[];this._scriptOrder=[];this._loadedScripts=[]};n._addItem=function(e){var n=this._createLoadItem(e);if(n!=null){this._loadQueue.push(n);this._numItems++;this._updateProgress();if(n.getItem().type==t.JAVASCRIPT){this._scriptOrder.push(n.getItem());this._loadedScripts.push(null)}}};n._loadNext=function(){if(this._paused)return;if(!this._loadStartWasDispatched){this._sendLoadStart();this._loadStartWasDispatched=!0}if(this._numItems==this._numItemsLoaded){this.loaded=!0;this._sendComplete();this.next&&this.next.load&&this.next.load.apply(this.next)}while(this._loadQueue.length&&this._currentLoads.length<this._maxConnections){var e=this._loadQueue.shift();this._loadItem(e)}};n._loadItem=function(e){e.onProgress=t.proxy(this._handleProgress,this);e.onComplete=t.proxy(this._handleFileComplete,this);e.onError=t.proxy(this._handleFileError,this);this._currentLoads.push(e);e.load()};n._handleFileError=function(e){var t=e.target,n=this._createResultData(t.getItem());this._numItemsLoaded++;this._updateProgress();this._sendError(n);if(!this.stopOnError){this._removeLoadItem(t);this._loadNext()}};n._createResultData=function(e){var t={id:e.id,result:null,data:e.data,type:e.type,src:e.src};this._loadedItemsById[e.id]=t;this._loadedItemsBySrc[e.src]=t;return t};n._handleFileComplete=function(e){var n=e.target,r=n.getItem(),i=this._createResultData(r);this._removeLoadItem(n);n instanceof t.lib.XHRLoader?i.result=this._createResult(r,n.getResult()):i.result=r.tag;switch(r.type){case t.IMAGE:if(n instanceof t.lib.XHRLoader){var s=this;i.result.onload=function(e){s._handleFileTagComplete(r,i)};return}break;case t.JAVASCRIPT:if(this.maintainScriptOrder){this._loadedScripts[this._scriptOrder.indexOf(r)]=r;this._checkScriptLoadOrder(n);return}}this._handleFileTagComplete(r,i)};n._checkScriptLoadOrder=function(){var e=this._loadedScripts.length;for(var t=0;t<e;t++){var n=this._loadedScripts[t];if(n===null)break;if(n===!0)continue;var r=this.getResult(n.src),i=this.getResult(n.id);i.result=r.result;this._handleFileTagComplete(r,i);this._loadedScripts[t]=!0;t--;e--}};n._handleFileTagComplete=function(e,t){this._numItemsLoaded++;e.completeHandler&&e.completeHandler(t);this._updateProgress();this._sendFileComplete(t);this._loadNext()};n._removeLoadItem=function(e){var t=this._currentLoads.length;for(var n=0;n<t;n++)if(this._currentLoads[n]==e){this._currentLoads.splice(n,1);break}};n._createResult=function(e,n){var r=null,i;switch(e.type){case t.IMAGE:r=this._createImage();break;case t.SOUND:r=e.tag||this._createAudio();break;case t.CSS:r=this._createLink();break;case t.JAVASCRIPT:r=this._createScript();break;case t.SVG:r=this._createSVG();var s=this._createXML(n,"image/svg+xml");r.appendChild(s);break;case t.XML:i=this._createXML(n,"text/xml");break;case t.JSON:case t.TEXT:i=n}if(r){e.type==t.CSS?r.href=e.src:e.type!=t.SVG&&(r.src=e.src);return r}return i};n._createXML=function(t,n){var r;if(e.DOMParser){var i=new DOMParser;r=i.parseFromString(t,n)}else{var i=new ActiveXObject("Microsoft.XMLDOM");i.async=!1;i.loadXML(t);r=i}return r};n._handleProgress=function(e){var t=e.target,n=this._createResultData(t.getItem());n.progress=t.progress;this._sendFileProgress(n);this._updateProgress()};n._updateProgress=function(){var e=this._numItemsLoaded/this._numItems,t=this._numItems-this._numItemsLoaded;if(t>0){var n=0;for(var r=0,i=this._currentLoads.length;r<i;r++)n+=this._currentLoads[r].progress;e+=n/t*(t/this._numItems)}this._sendProgress({loaded:e,total:1})};n._createLoadItem=function(e){var n={};switch(typeof e){case"string":n.src=e;break;case"object":if(e instanceof HTMLAudioElement){n.tag=e;n.src=n.tag.src;n.type=t.SOUND}else n=e;break;default:}n.ext=this._getNameAfter(n.src,".");n.type||(n.type=this.getType(n.ext));if(n.id==null||n.id=="")n.id=n.src;var r=this.typeHandlers[n.type]||this.extensionHandlers[n.ext];if(r){var i=r(n.src,n.type,n.id,n.data);if(i===!1)return null;if(i!==!0){i.src!=null&&(n.src=i.src);i.id!=null&&(n.id=i.id);i.tag!=null&&i.tag.load instanceof Function&&(n.tag=i.tag)}n.ext=this._getNameAfter(n.src,".")}var s=this.useXHR;switch(n.type){case t.JSON:case t.XML:case t.TEXT:s=!0;break;case t.SOUND:n.ext=="ogg"&&t.TAG_LOAD_OGGS&&(s=!1)}if(this.useXHR!=1||n.type!=t.IMAGE&&n.type!=t.SVG)return s?new t.lib.XHRLoader(n):n.tag?new t.lib.TagLoader(n):this._createTagItem(n);var o=this._createTagItem(n);o.useXHR=!0;return o};n._createTagItem=function(e){var n,r="src",i=!1;switch(e.type){case t.IMAGE:n=this._createImage();break;case t.SOUND:n=this._createAudio();break;case t.CSS:r="href";i=!0;n=this._createLink();break;case t.JAVASCRIPT:i=!0;n=this._createScript();break;case t.SVG:r="data";n=this._createSVG();break;default:}e.tag=n;return new t.lib.TagLoader(e,r,i)};n.getType=function(e){switch(e){case"jpeg":case"jpg":case"gif":case"png":return t.IMAGE;case"ogg":case"mp3":case"wav":return t.SOUND;case"json":return t.JSON;case"xml":return t.XML;case"css":return t.CSS;case"js":return t.JAVASCRIPT;case"svg":return t.SVG;default:return t.TEXT}};n._getNameAfter=function(e,t){var n=e.lastIndexOf(t),r=e.substr(n+1),i=r.lastIndexOf(/[\b|\?|\#|\s]/);return i==-1?r:r.substr(0,i)};n._createImage=function(){return document.createElement("img")};n._createSVG=function(){var e=document.createElement("object");e.type="image/svg+xml";return e};n._createAudio=function(){var e=document.createElement("audio");e.autoplay=!1;e.type="audio/ogg";return e};n._createScript=function(){var e=document.createElement("script");e.type="text/javascript";return e};n._createLink=function(){var e=document.createElement("link");e.type="text/css";e.rel="stylesheet";return e};n.toString=function(){return"[PreloadJS]"};r.proxy=function(e,t){return function(n){return e.apply(t,arguments)}};t.lib={};e.PreloadJS=t;var i=function(){};i.init=function(){var t=navigator.userAgent;i.isFirefox=t.indexOf("Firefox")>-1;i.isOpera=e.opera!=null;i.isIOS=t.indexOf("iPod")>-1||t.indexOf("iPhone")>-1||t.indexOf("iPad")>-1};i.init();t.lib.BrowserDetect=i;Array.prototype.indexOf||(Array.prototype.indexOf=function(t){if(this===void 0||this===null)throw new TypeError;var n=Object(this),r=n.length>>>0;if(!r)return-1;var i=0;arguments.length>1&&(i=toInteger(arguments[1]));i=i>=0?i:r-Math.abs(i);for(;i<r;i++)if(i in n&&n[i]===t)return i;return-1})})(window);(function(e){var t=function(e){this.init(e)},n=t.prototype=new AbstractLoader;n._wasLoaded=!1;n._request=null;n._loadTimeOutTimeout=null;n._xhrLevel=null;n.init=function(e){this._item=e;!this._createXHR(e)};n.getResult=function(){try{return this._request.responseText}catch(e){}return this._request.response};n.cancel=function(){this._clean();this._request.abort()};n.load=function(){if(this._request==null){this.handleError();return}this._xhrLevel==1&&(this._loadTimeOutTimeout=setTimeout(PreloadJS.proxy(this.handleTimeout,this),PreloadJS.TIMEOUT_TIME));this._request.onloadstart=PreloadJS.proxy(this.handleLoadStart,this);this._request.onprogress=PreloadJS.proxy(this.handleProgress,this);this._request.onabort=PreloadJS.proxy(this.handleAbort,this);this._request.onerror=PreloadJS.proxy(this.handleError,this);this._request.ontimeout=PreloadJS.proxy(this.handleTimeout,this);this._request.onload=PreloadJS.proxy(this.handleLoad,this);this._request.onreadystatechange=PreloadJS.proxy(this.handleReadyStateChange,this);try{this._request.send()}catch(e){this._sendError({source:e})}};n.handleProgress=function(e){if(e.loaded>0&&e.total==0)return;this._sendProgress({loaded:e.loaded,total:e.total})};n.handleLoadStart=function(){clearTimeout(this._loadTimeOutTimeout);this._sendLoadStart()};n.handleAbort=function(){this._clean();this._sendError()};n.handleError=function(){this._clean();this._sendError()};n.handleReadyStateChange=function(){this._request.readyState==4&&this.handleLoad()};n._checkError=function(){var e=parseInt(this._request.status);switch(e){case 404:case 0:return!1}return this._hasResponse()||this._hasTextResponse()||this._hasXMLResponse()};n._hasResponse=function(){return this._request.response!=null};n._hasTextResponse=function(){try{return this._request.responseText!=null}catch(e){return!1}};n._hasXMLResponse=function(){try{return this._request.responseXML!=null}catch(e){return!1}};n.handleLoad=function(e){if(this.loaded)return;this.loaded=!0;if(!this._checkError()){this.handleError();return}this._clean();this._sendComplete()};n.handleTimeout=function(){this._clean();this._sendError()};n._createXHR=function(t){this._xhrLevel=1;e.ArrayBuffer&&(this._xhrLevel=2);if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){var n=new Number(RegExp.$1);n>=8&&(this._request=new XDomainRequest)}else if(e.XMLHttpRequest)this._request=new XMLHttpRequest;else try{this._request=new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(r){return null}t.type==PreloadJS.TEXT&&this._request.overrideMimeType&&this._request.overrideMimeType("text/plain; charset=x-user-defined");this._request.open("GET",t.src,!0);PreloadJS.isBinary(t.type)&&(this._request.responseType="arraybuffer");return!0};n._clean=function(){clearTimeout(this._loadTimeOutTimeout);var e=this._request;e.onloadstart=null;e.onprogress=null;e.onabort=null;e.onerror=null;e.onload=null;e.ontimeout=null;e.onloadend=null;e.onreadystatechange=null;clearInterval(this._checkLoadInterval)};n.toString=function(){return"[PreloadJS XHRLoader]"};PreloadJS.lib.XHRLoader=t})(window);(function(e){var t=function(e,t,n){this.init(e,t,n)},n=t.prototype=new AbstractLoader;n._srcAttr=null;n._loadTimeOutTimeout=null;n.tagCompleteProxy=null;n.init=function(t,n,r){this._item=t;this._srcAttr=n||"src";this.useXHR=r==1;this.isAudio=e.HTMLAudioElement?t.tag instanceof HTMLAudioElement:!1;this.tagCompleteProxy=PreloadJS.proxy(this._handleTagLoad,this)};n.cancel=function(){this._clean();var e=this.getItem();e!=null&&(e.src=null)};n.load=function(){this.useXHR?this.loadXHR():this.loadTag()};n.loadXHR=function(){var e=this.getItem(),t=new PreloadJS.lib.XHRLoader(e);t.onProgress=PreloadJS.proxy(this._handleProgress,this);t.onFileLoad=PreloadJS.proxy(this._handleXHRComplete,this);t.onComplete=PreloadJS.proxy(this._handleXHRComplete,this);t.onError=PreloadJS.proxy(this._handleLoadError,this);t.load()};n._handleXHRComplete=function(e){this._clean();e.target.onFileLoad=null;e.target.onComplete=null;var t=e.target.getItem(),n=e.target.getResult();if(t.type==PreloadJS.IMAGE){t.tag.onload=PreloadJS.proxy(this._sendComplete,this);t.tag.src=t.src}else{t.tag[this._srcAttr]=t.src;this._sendComplete()}};n._handleLoadError=function(e){if(e.error&&e.error.code==101)this.loadTag();else{this._clean();this._sendError(e)}};n.loadTag=function(){var e=this.getItem(),t=e.tag;clearTimeout(this._loadTimeOutTimeout);this._loadTimeOutTimeout=setTimeout(PreloadJS.proxy(this._handleLoadTimeOut,this),PreloadJS.TIMEOUT_TIME);if(this.isAudio){t.src=null;t.preload="auto";t.setAttribute("data-temp","true")}t.onerror=PreloadJS.proxy(this._handleLoadError,this);t.onprogress=PreloadJS.proxy(this._handleProgress,this);if(this.isAudio){t.onstalled=PreloadJS.proxy(this._handleStalled,this);t.addEventListener("canplaythrough",this.tagCompleteProxy,!1)}else t.onload=PreloadJS.proxy(this._handleTagLoad,this);t[this._srcAttr]=e.src;e.type==PreloadJS.SVG&&document.getElementsByTagName("body")[0].appendChild(t);var n=e.type==PreloadJS.SOUND&&e.ext=="ogg"&&PreloadJS.lib.BrowserDetect.isFirefox;t.load!=null&&!n&&t.load()};n._handleLoadTimeOut=function(){this._clean();this._sendError()};n._handleStalled=function(){};n._handleLoadError=function(e){this._clean();this._sendError()};n._handleTagLoad=function(e){var t=this.getItem().tag;clearTimeout(this._loadTimeOutTimeout);if(this.loaded||this.isAudio&&t.readyState!==4)return;this.getItem().type==PreloadJS.SVG&&document.getElementsByTagName("body")[0].removeChild(t);this.loaded=!0;this._clean();this._sendComplete()};n._clean=function(){clearTimeout(this._loadTimeOutTimeout);var e=this.getItem().tag;e.onload=null;e.removeEventListener&&e.removeEventListener("canplaythrough",this.tagCompleteProxy,!1);e.onstalled=null;e.onprogress=null;e.onerror=null};n._handleProgress=function(e){clearTimeout(this._loadTimeOutTimeout);var t=e;if(this.isAudio){var n=this.getItem();if(n.buffered==null)return;t={loaded:n.buffered.length>0?n.buffered.end(0):0,total:n.duration}}this._sendProgress(t)};n.toString=function(){return"[PreloadJS TagLoader]"};PreloadJS.lib.TagLoader=t})(window);